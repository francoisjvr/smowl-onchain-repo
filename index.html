<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SMOWL — Onchain Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Load ethers FIRST and defer -->
  <script defer src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0b0b0b;
      color: #eaeaea;
      margin: 0;
      padding: 24px;
    }
    h1 { font-size: 20px; }
    input, button {
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      border: none;
    }
    input {
      width: 120px;
      margin-right: 8px;
    }
    button {
      cursor: pointer;
      background: #b6ff6b;
      color: #000;
      font-weight: 600;
    }
    pre {
      background: #111;
      padding: 12px;
      border-radius: 10px;
      max-height: 300px;
      overflow: auto;
      margin-top: 16px;
    }
    img {
      max-width: 100%;
      margin-top: 16px;
      border-radius: 12px;
      background: #000;
    }
  </style>
</head>

<body>

<h1>SMOWL — Onchain Viewer (Shape)</h1>

<p class="small">
Contract: <code>0xd74063355d6E0BcA71C821B731532B2fB72C76bc</code>
</p>

<div>
  <input id="tokenId" value="1" />
  <button onclick="loadSMOWL()">Load</button>
</div>

<pre id="output">idle</pre>
<img id="image" />

<script>
/**
 * This is intentionally simple and defensive.
 * No IIFEs, no DOM timing assumptions.
 */

async function loadSMOWL() {
  const out = document.getElementById("output");
  const img = document.getElementById("image");
  const tokenId = document.getElementById("tokenId").value;

  out.textContent = "loading…";
  img.removeAttribute("src");

  if (typeof ethers === "undefined") {
    out.textContent = "ERROR: ethers.js not loaded";
    return;
  }

  try {
    const CONTRACT = "0xd74063355d6E0BcA71C821B731532B2fB72C76bc";
    const RPC = "https://mainnet.shape.network";
    const CHAIN_ID = 360;

    const ABI = [
      "function tokenURI(uint256) view returns (string)",
      "function image(uint256) view returns (bytes)"
    ];

    const provider = new ethers.JsonRpcProvider(RPC, CHAIN_ID);
    const contract = new ethers.Contract(CONTRACT, ABI, provider);

    const uri = await contract.tokenURI(BigInt(tokenId));
    let parsed;

    try {
      parsed = JSON.parse(uri);
      out.textContent = JSON.stringify(parsed, null, 2);
    } catch {
      out.textContent = uri;
      return;
    }

    // IMAGE HANDLING
    if (parsed.image && parsed.image.startsWith("data:image")) {
      img.src = parsed.image;
      return;
    }

    if (parsed.image && parsed.image.startsWith("web3://")) {
      const m = parsed.image.match(
        /^web3:\\/\\/(0x[a-fA-F0-9]{40}):(\\d+)\\/image\\/(\\d+)$/
      );
      if (!m) throw new Error("Invalid web3 image URI");

      const [, addr, chainId, imgId] = m;
      if (Number(chainId) !== CHAIN_ID) throw new Error("Wrong chain");

      const imgContract = new ethers.Contract(addr, ABI, provider);
      const bytes = ethers.getBytes(await imgContract.image(BigInt(imgId)));
      img.src = URL.createObjectURL(new Blob([bytes], { type: "image/webp" }));
      return;
    }

    if (parsed.image) {
      img.src = parsed.image;
    }

  } catch (err) {
    out.textContent = "ERROR: " + err.message;
  }
}
</script>

</body>
</html>
